# Generated by Django 3.2.5 on 2021-12-23 14:53
import os
import shutil
import tqdm
from django.db import migrations
from django.conf import settings


def atualizar(qs, field_str, path):
    marcar_para_deletar = []
    folder = os.path.join(settings.MEDIA_ROOT, path)
    os.makedirs(folder, exist_ok=True)
    for obj in tqdm.tqdm(qs):
        field = getattr(obj, field_str)
        file_name = field.name
        file_name = file_name and file_name.startswith('./') and file_name[2:] or file_name
        if file_name:
            original = os.path.join(settings.MEDIA_ROOT, file_name)
            marcar_para_deletar.append(original)
            target = os.path.join(folder, file_name)
            setattr(obj, field_str, os.path.join(path, file_name))
            obj.save()
            if not settings.DEBUG:
                shutil.copyfile(original, target)
    if not settings.DEBUG:
        for arquivo in marcar_para_deletar:
            os.remove(arquivo)
    with open(os.path.join(settings.MEDIA_ROOT, 'arquivos_excluidos.txt'), 'a') as f:
        for arquivo in marcar_para_deletar:
            f.write(arquivo + '\n')
    return marcar_para_deletar


def atualizar_dados(apps, schema):
    print('\natualizando banner\n')
    Banner = apps.get_model('eventos.Banner')
    atualizar(Banner.objects.all(), 'imagem', 'eventos/banner')


class Migration(migrations.Migration):

    dependencies = [
        ('eventos', '0026_alter_banner_imagem'),
    ]

    operations = [
        migrations.RunPython(atualizar_dados),
    ]

# Generated by Django 2.2.10 on 2020-07-07 22:42
import tqdm
from django.db import migrations
import json


def atualizar_dados(apps, schema):
    SolicitacaoEtapa = apps.get_model('catalogo_provedor_servico.SolicitacaoEtapa')
    for solicitacao_etapa in tqdm.tqdm(SolicitacaoEtapa.objects.all()):
        campos = json.loads(solicitacao_etapa.dados)
        for i, field in enumerate(campos['formulario']):
            if 'display_value' not in field and 'choices' in field:
                choices = field['choices']
                display_value = ''
                value = field.get('value')
                if value:
                    if isinstance(choices, dict):
                        choices = choices.items()
                    for choice_key, choice_value in choices:
                        if str(value) == str(choice_key):
                            display_value = choice_value
                campos['formulario'][i]['display_value'] = display_value
        solicitacao_etapa.dados = json.dumps(campos)
        solicitacao_etapa.save()


class Migration(migrations.Migration):

    dependencies = [
        ('catalogo_provedor_servico', '0027_solicitacao_dados_registros_execucao'),
    ]

    operations = [
        migrations.RunPython(atualizar_dados)
    ]
